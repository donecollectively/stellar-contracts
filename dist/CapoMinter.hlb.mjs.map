{"version":3,"file":"CapoMinter.hlb.mjs","sources":["../src/minting/CapoMinter.hlb.ts"],"sourcesContent":["import type { Source } from \"@helios-lang/compiler-utils\";\nimport { CapoHeliosBundle } from \"../helios/scriptBundling/CapoHeliosBundle.js\";\nimport type { CapoConfig } from \"../CapoTypes.js\";\nimport type { DeployedScriptDetails } from \"../configuration/DeployedScriptConfigs.js\";\nimport { CapoDelegateBundle } from \"../helios/scriptBundling/CapoDelegateBundle.js\";\nimport { HeliosScriptBundle } from \"../helios/scriptBundling/HeliosScriptBundle.js\";\n\nimport CapoMinterScript from \"./CapoMinter.hl\";\nimport type { StellarBundleSetupDetails } from \"../StellarContract.js\";\n\n\n// this class expresses a \"has dependences from the Capo\" semantic,\n// ... not because it expects any dynamic code dependencies from an\n// ... application-specific Capo, but rather by simple convention of playing\n// ... in the pattern of \"Capo provides dependency code\".\n//\n// It can safely get its code dependencies from the normal, unspecialized \n// Capo bundle\n\n/**\n * for the special Capo minter; makes the Capo's modules available\n * to the minter for imports\n **/\nexport class CapoMinterBundle \nextends HeliosScriptBundle.usingCapoBundleClass(CapoHeliosBundle) {\n    static currentRev = 1n;\n    \n    scriptParamsSource: \"config\" | \"bundle\" = \"config\"\n    //pro-forma to make TypeScript happy\n    requiresGovAuthority = true;\n\n    static needsSpecializedDelegateModule = false\n    static needsCapoConfiguration = true\n    \n    declare capoBundle: CapoHeliosBundle;\n    // constructor(\n    //     setupDetails?: StellarBundleSetupDetails<any>\n    // ) {\n    //     super(setupDetails);\n    //     //@ts-expect-error setting the required property\n    // }\n\n    get params() {\n        const {configuredScriptDetails, configuredParams } = this.capoBundle || {}\n        \n        const noConfig = `${this.constructor.name}: capoMph not found in deployed capo bundle; can't make config yet (dbpa)`;\n        if (!configuredScriptDetails) {\n            \n            if (configuredParams) {                \n                console.warn(noConfig);\n                debugger\n            }\n            return {rev: this.rev}\n        }\n        const capoConfig = (configuredScriptDetails as DeployedScriptDetails<CapoConfig>).config\n        const {\n            mph,\n            seedTxn,\n            seedIndex,\n        } = capoConfig\n        if (!mph) {\n            console.warn(noConfig);\n            debugger\n            throw new Error(noConfig) // ????\n            return undefined\n        }\n\n        return {\n            rev: this.rev,\n            seedTxn,\n            seedIndex\n        }\n    }\n\n    // // no datum types in this script\n    // declare Activity: makesUplcActivityEnumData<MinterActivityLike>;\n\n    // constructor(capoBundle: CapoHeliosBundle) {\n    //     super();\n    //     this.capoBundle = capoBundle;\n    // }\n\n    get main(): Source {\n        return CapoMinterScript;\n    }    \n\n    async loadPrecompiledVariant(variant: string) {\n        if (variant !== \"singleton\") {\n            throw new Error(`unknown minter variant: ${variant}`);\n        }\n        return this.capoBundle.loadPrecompiledMinterScript()\n        // return super.loadPrecompiledVariant(variant);\n    }\n\n    // automatically-included modules from Capo don't need to be specified\n    // get modules() {\n    //     return [...this.capoBundle.modules];\n    // }\n\n    init(setupDetails: StellarBundleSetupDetails<any>) {\n        const {capo} = setupDetails.params || {}\n        if (capo?._bundle) {\n            this.capoBundle = capo._bundle;\n        }\n        const {minter: minterDetails} = this.capoBundle.precompiledScriptDetails || {}\n        if (minterDetails) {\n            this.precompiledScriptDetails = {\n                singleton: minterDetails\n            }\n            this.configuredScriptDetails = minterDetails\n            this.scriptParamsSource = \"bundle\"\n        }\n        super.init(setupDetails)\n    }\n\n}\n\nexport default CapoMinterBundle"],"names":["CapoMinterScript"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAuBO,MAAM,gBAAA,SACL,kBAAA,CAAmB,oBAAA,CAAqB,gBAAgB,CAAA,CAAE;AAAA,EAC9D,OAAO,UAAA,GAAa,EAAA;AAAA,EAEpB,kBAAA,GAA0C,QAAA;AAAA;AAAA,EAE1C,oBAAA,GAAuB,IAAA;AAAA,EAEvB,OAAO,8BAAA,GAAiC,KAAA;AAAA,EACxC,OAAO,sBAAA,GAAyB,IAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUhC,IAAI,MAAA,GAAS;AACT,IAAA,MAAM,EAAC,uBAAA,EAAyB,gBAAA,EAAiB,GAAI,IAAA,CAAK,cAAc,EAAC;AAEzE,IAAA,MAAM,QAAA,GAAW,CAAA,EAAG,IAAA,CAAK,WAAA,CAAY,IAAI,CAAA,yEAAA,CAAA;AACzC,IAAA,IAAI,CAAC,uBAAA,EAAyB;AAE1B,MAAA,IAAI,gBAAA,EAAkB;AAClB,QAAA,OAAA,CAAQ,KAAK,QAAQ,CAAA;AACrB,QAAA;AAAA,MACJ;AACA,MAAA,OAAO,EAAC,GAAA,EAAK,IAAA,CAAK,GAAA,EAAG;AAAA,IACzB;AACA,IAAA,MAAM,aAAc,uBAAA,CAA8D,MAAA;AAClF,IAAA,MAAM;AAAA,MACF,GAAA;AAAA,MACA,OAAA;AAAA,MACA;AAAA,KACJ,GAAI,UAAA;AACJ,IAAA,IAAI,CAAC,GAAA,EAAK;AACN,MAAA,OAAA,CAAQ,KAAK,QAAQ,CAAA;AACrB,MAAA;AACA,MAAA,MAAM,IAAI,MAAM,QAAQ,CAAA;AACjB,IACX;AAEA,IAAA,OAAO;AAAA,MACH,KAAK,IAAA,CAAK,GAAA;AAAA,MACV,OAAA;AAAA,MACA;AAAA,KACJ;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,IAAI,IAAA,GAAe;AACf,IAAA,OAAOA,aAAA;AAAA,EACX;AAAA,EAEA,MAAM,uBAAuB,OAAA,EAAiB;AAC1C,IAAA,IAAI,YAAY,WAAA,EAAa;AACzB,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,wBAAA,EAA2B,OAAO,CAAA,CAAE,CAAA;AAAA,IACxD;AACA,IAAA,OAAO,IAAA,CAAK,WAAW,2BAAA,EAA4B;AAAA,EAEvD;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,KAAK,YAAA,EAA8C;AAC/C,IAAA,MAAM,EAAC,IAAA,EAAI,GAAI,YAAA,CAAa,UAAU,EAAC;AACvC,IAAA,IAAI,MAAM,OAAA,EAAS;AACf,MAAA,IAAA,CAAK,aAAa,IAAA,CAAK,OAAA;AAAA,IAC3B;AACA,IAAA,MAAM,EAAC,MAAA,EAAQ,aAAA,KAAiB,IAAA,CAAK,UAAA,CAAW,4BAA4B,EAAC;AAC7E,IAAA,IAAI,aAAA,EAAe;AACf,MAAA,IAAA,CAAK,wBAAA,GAA2B;AAAA,QAC5B,SAAA,EAAW;AAAA,OACf;AACA,MAAA,IAAA,CAAK,uBAAA,GAA0B,aAAA;AAC/B,MAAA,IAAA,CAAK,kBAAA,GAAqB,QAAA;AAAA,IAC9B;AACA,IAAA,KAAA,CAAM,KAAK,YAAY,CAAA;AAAA,EAC3B;AAEJ;;;;"}
#!/usr/bin/env bash
# set -x # debug mode
#set -e # exit on error
#//! EXPECTS to be run in context of `pnpm exec`

srcDir=$(dirname $0)
STC_PROJECT_PITCH=0
. $srcDir/support.sh

startTime=$(date)

# programDTS() {
#     tsc -p ./tsconfig.programWithCacheAPI.dts.json &&
#     withDocs api-extractor run --local  -c api-extractor.programWithCacheAPI.json 
# }

makeHeliosProgramWithCacheAPI() {
    # inBackground "-- cacheable program .d.ts" \
    #     programDTS

    $ESBUILD --platform=node $ESBUILD_EXTERNALS \
        --drop-labels=__BROWSER_ONLY__ \
        --outfile=dist/HeliosProgramWithFSCache.mjs \
        src/helios/HeliosProgramWithFSCache.ts
    $ESBUILD $ESBUILD_EXTERNALS \
        --drop-labels=__NODEJS_ONLY__ \
        --outfile=dist/HeliosProgramWithMockCacheAPI.mjs \
        src/helios/HeliosProgramWithMockCacheAPI.ts    
}


playStartSound &
{
    pushd dist.overlay >/dev/null
    find . -type f | while read a ; do {
        cp $a ../dist/$a    
        touch ../dist/$a    
    } done
    popd >/dev/null

    inBackground "make dist/HeliosProgramWithCacheAPI" \
        makeHeliosProgramWithCacheAPI &
        # ... has nested background jobs.
        # ... needed for the rollup plugin

    wait  # for stuff above to finish
    copyTypeInfoDTSFiles

    makeRollupPlugin &
    inBackground "typecheck all, create .d.ts types for all packages" \
        tsc -p ./tsconfig.all.dts.json  &

    inBackground "build docs" \
        pnpm docs:generate &
}  

echo "In foreground: rollup main code bundle" 
./scripts/rollup || {
   logProblemWith "rollup main code bundle"
   echo "error in rollup main code bundle"
   wait
   exit 42
}

sleep 0.5
echo "------------------------------ waiting ------------------------------"
wait
playCheckpointSound


# {
    # inBackground "main .d.ts rollup using rollup-plugin-dts" \
    #     ./scripts/rollup  &

#    inBackground "doc generation (api-extractor)" \
#        withDocs api-extractor run --local  &

# }


wait

echo "build started at  $startTime"
echo "build finished at $(date)"

exitIfError
playSuccessSound 
wait

# api-extractor run --local --verbose

# to debug rollup plugins:
#   pnpm exec node --inspect-brk \
#      node_modules/rollup/dist/bin/rollup \
#         --config rollup.config.ts \
#         --configPlugin 'esbuild={loaders:{".json": "json"}, target: "esnext", tsconfig:"./tsconfig.rollupconfig.json"}'
